#!/usr/bin/env -S fontforge -quiet
# -*- mode: python; coding: utf-8 -*-
import os, sys, argparse, fontforge, json, math
progname = os.path.basename(__file__).split(".")[0]
def main():
    global args, progname
    parser = argparse.ArgumentParser()
    parser.add_argument("filenames", nargs="+")
    parser.add_argument("--run-as", "--as")
    parser.add_argument("--path", action="store_true")
    parser.add_argument("--verbose", "-v", action="count", default=0)
    args = parser.parse_args()
    is_silent = args.verbose < 2
    if args.run_as is not None:
        progname = args.run_as
    for filename in args.filenames:
        basename = os.path.basename(filename)
        # visible_filename = filename if args.path else visible_filename = os.path.basename(filename)
        fonts_in_file = fontforge.fontsInFile(filename)
        font_hashes = None
        if len(fonts_in_file) < 2:
            font_hashes = [{ "filename_font": filename,
                             "basename_font": basename,
                             "filename": filename }]
        else:
            font_hashes = [{ "filename_font": "%s(%s)" % (filename, font_in_file),
                             "basename_font": "%s(%s)" % (basename, font_in_file),
                             "filename": filename,
                             "font_in_file": font_in_file }
                           for font_in_file in fonts_in_file]
        for font_hash in font_hashes:
            filename = font_hash["filename"]
            filename_font = font_hash["filename_font"]
            basename_font = font_hash["basename_font"]
            try:
                if is_silent: silence(True)
                font = fontforge.open(filename_font)
            except Exception as err:
                if is_silent: silence(False)
                raise err
            if is_silent: silence(True)
            visible_filename_font = filename_font if args.path else basename_font
            if progname == "fontfamily":
                print("%-40s  %s" % (font.familyname, visible_filename_font))
            elif progname == "fontname":
                print("%-40s  %s" % (font.fontname, visible_filename_font))
            elif progname == "fontfullname":
                print("%-40s  %s" % (font.fullname, visible_filename_font))
            elif progname == "fontweight":
                print("%-40s  %s" % (font.weight, visible_filename_font))
            elif progname == "fontvendor":
                print("%-40s  %s" % (font.os2_vendor, visible_filename_font))
            elif progname == "fontversion":
                rev = "%-.3f" % font.sfntRevision
                print("%-19s  %-19s  %s" % (rev, font.version, visible_filename_font))
            elif progname == "fontinfo":
                rev = "%-.3f" % font.sfntRevision
                print("%s:" % visible_filename_font)
                print("    %-36s  %s" % ("PostScript font name:", font.fontname))
                print("    %-36s  %s" % ("full name:",            font.fullname))
                print("    %-36s  %s" % ("family name:",          font.familyname))
                print("    %-36s  %s" % ("weight name:",          font.weight))
                print("    %-36s  %s" % ("version:",              font.version))
                print("    %-36s  %s" % ("sfnt rev:",             rev))
                print("    %-36s  %s" % ("vendor:",               font.os2_vendor))
            elif progname == "fontmetrics":
                print("%s:" % visible_filename_font)
                print("    %-36s  %s" % ("em:",           font.em))
                print("    %-36s  %s" % ("ascent:",       (font.ascent, font.ascent / font.em)))
                print("    %-36s  %s" % ("descent:",      (font.descent, font.descent / font.em)))
                print("    %-36s  %s" % ("cap height:",   (font.capHeight, font.capHeight / font.em)))
                print("    %-36s  %s" % ("ex height:",    (font.xHeight, font.xHeight / font.em)))
                print("    %-36s  %s" % ("italic angle:", font.italicangle))
            else:
                raise Exception("don't know what to do when running as %s" % repr(progname))

stderr_fd = os.dup(2)
def silence(flag=True):
    global stderr_fd
    if flag:
        try:
            os.close(2)
        except OSError:
            pass
    else:
        try:
            os.dup2(stderr_fd, 2)
        except OSError:
            pass

main()
